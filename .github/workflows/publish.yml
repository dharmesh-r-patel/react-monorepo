name: Publish Packages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main      
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org/'

      - name: Setup Yarn
        run: yarn set version stable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Build Packages
        run: yarn build

      - name: Setup .npmrc
        run: |
          echo "registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "@infineit:registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          cat ~/.npmrc

      - name: Verify npm authentication
        run: npm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Bump version (if needed)
        run: |
            git fetch --tags
            lerna version patch --yes --no-private --force-publish
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Bump version (if needed)
      #   run: lerna version patch --yes --no-private --force-publish

      - name: Commit changes (if any)
        run: |
          git config --global user.email "dharmeshbbay@gmail.com"
          git config --global user.name "Dharmesh Patel"
          git add -A
          git commit -m "chore: commit changes before publish" || echo "No changes to commit"

      - name: Debug Lerna Publish
        run: lerna publish from-package --yes --loglevel verbose
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


# name: Publish Packages

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main      
#   workflow_dispatch:

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20.x'
#           registry-url: 'https://registry.npmjs.org/'

#       - name: Setup Yarn
#         run: yarn set version stable

#       - name: Install Dependencies
#         run: yarn install --immutable

#       - name: Build Packages
#         run: lerna run build --ignore docs

#       - name: Authenticate npm
#         run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

#       - name: Verify npm authentication
#         run: npm whoami
#         env:
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

#       - name: Commit changes (if any)  # Add this step
#         run: |
#             git config --global user.name "GitHub Actions"
#             git config --global user.email "actions@github.com"
#             git add -A
#             git commit -m "chore: commit changes before publish" || echo "No changes to commit"

#       - name: Publish to NPM
#         run: lerna publish from-package --yes --force-publish
#         env:
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


# name: Publish Packages

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main      
#   workflow_dispatch:

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20.x'
#           registry-url: 'https://registry.npmjs.org/'

#       - name: Setup Yarn
#         run: yarn set version stable

#       - name: Install Dependencies
#         run: yarn install --immutable

#       - name: Build Packages
#         run: lerna run build --ignore docs

#       - name: Authenticate npm
#         run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

#       - name: Verify npm authentication
#         run: npm whoami

#       - name: Publish to NPM
#         run: lerna publish from-package --yes
#         env:
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


# name: Publish Packages

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#         - main      
#   workflow_dispatch:

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#             node-version: '20.x'

#       - name: Install Dependencies
#         run: yarn install

#       - name: Print current directory
#         run: pwd        

#       - name: Build Packages
#         run: lerna run build --ignore docs

#       - name: Bump Versions
#         run: |
#             git config --global user.email "dharmeshbbay@gmail.com"
#             git config --global user.name "Dharmesh Patel"
#             lerna version --yes

#       - name: Authenticate npm
#         run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

#       - name: Verify npm authentication
#         run: npm whoami


#       - name: Publish to NPM
#         run: lerna publish from-package --yes
#         env:
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
